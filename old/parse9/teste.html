<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Formulário Universal Offline</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 2px 2px 10px #eee; }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .save-btn { background-color: #007bff; color: white; }
        .sync-btn { background-color: #28a745; color: white; }
        .get-btn { background-color: #6c757d; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>

    <div class="card">
        <h3>Formulário Dinâmico</h3>
        <form id="meuForm">
            <input type="text" id="projeto" placeholder="Nome do Projeto" required>
            <input type="number" id="valor" placeholder="Valor Estimado">
            <textarea id="descricao" placeholder="Descrição do item"></textarea>
            <button type="submit" class="save-btn">Salvar Local (IndexedDB)</button>
        </form>
    </div>

    <div class="actions">
        <button class="sync-btn" onclick="sincronizar()">Sincronizar com Nuvem</button>
        <button class="get-btn" onclick="baixarDados()">Visualizar Planilha</button>
    </div>

    <p id="status"></p>

    <div id="tabelaContainer" style="overflow-x:auto;">
        <table id="tabelaDados">
            <thead><tr id="headerRow"></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbzKsNdozd1k2ich7bDbMilA4rdlqRM3Kvsi4ntxEAeeG8xeZBta6dOlkAMjUOx00uE4/exec"; 
        let db;

        // Banco de Dados Universal
        const request = indexedDB.open("UniversalDB", 1);
        request.onupgradeneeded = e => {
            e.target.result.createObjectStore("store", { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = e => db = e.target.result;

        // CAPTURA DINÂMICA: Transforma qualquer formulário em JSON
        document.getElementById('meuForm').onsubmit = e => {
            e.preventDefault();
            const formData = {};
            const elements = e.target.querySelectorAll("input, textarea, select");
            
            elements.forEach(el => {
                formData[el.id] = el.value;
            });

            const tx = db.transaction("store", "readwrite");
            tx.objectStore("store").add(formData);
            tx.oncomplete = () => {
                alert("Dados guardados no navegador!");
                e.target.reset();
            };
        };

        // Sincronização em Lote
        async function sincronizar() {
            const status = document.getElementById('status');
            status.innerText = "Sincronizando...";
            
            const tx = db.transaction("store", "readonly");
            const dados = await new Promise(res => tx.objectStore("store").getAll().onsuccess = e => res(e.target.result));

            if (dados.length === 0) return status.innerText = "Nada pendente.";

            for (let item of dados) {
                // Remove o ID do IndexedDB antes de enviar para a planilha não ficar poluída
                const { id, ...dadosParaEnviar } = item; 
                await fetch(SHEETS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(dadosParaEnviar) });
            }

            db.transaction("store", "readwrite").objectStore("store").clear();
            status.innerText = "Sincronização concluída!";
            baixarDados();
        }

        // Gera Tabela Automaticamente baseada no que vier da Planilha
        async function baixarDados() {
            document.getElementById('status').innerText = "Baixando...";
            try {
                const res = await fetch(SHEETS_URL);
                const rows = await res.json();
                
                const thead = document.getElementById('headerRow');
                const tbody = document.querySelector("#tabelaDados tbody");
                thead.innerHTML = ""; tbody.innerHTML = "";

                rows.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const el = document.createElement(index === 0 ? 'th' : 'td');
                        el.innerText = cell;
                        tr.appendChild(el);
                    });
                    if (index === 0) thead.appendChild(tr);
                    else tbody.appendChild(tr);
                });
                document.getElementById('status').innerText = "Dados atualizados.";
            } catch (e) {
                document.getElementById('status').innerText = "Erro ao carregar dados.";
            }
        }
    </script>
</body>
</html>