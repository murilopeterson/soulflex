<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Formulário com Tabela</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        input { width: 100%; margin: 10px 0; padding: 8px; box-sizing: border-box; }
        button { padding: 10px; cursor: pointer; margin: 5px 0; width: 100%; }
        .sync-btn { background-color: #28a745; color: white; border: none; }
        .get-btn { background-color: #007bff; color: white; border: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f4f4f4; }
    </style>
</head>
<body>

    <h3>Cadastro Offline (IndexedDB)</h3>
    <form id="meuForm">
        <input type="text" id="nome" placeholder="Nome" required>
        <input type="email" id="email" placeholder="E-mail" required>
        <button type="submit">Salvar Localmente</button>
    </form>

    <hr>

    <button class="sync-btn" onclick="sincronizarDados()">Sincronizar Dados Locais -> Planilha</button>
    <button class="get-btn" onclick="buscarDadosDaPlanilha()">Carregar Dados da Planilha</button>
    
    <p id="status"></p>

    <div id="tabelaContainer">
        <h4>Dados na Planilha:</h4>
        <table id="tabelaDados">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbx_sW5Sl_i6pDyQFy2Tt0EOJP7kqOoyq2qsTSqBCYIKgo3p9uvI0YWZoWYxwO2WURke/exec"; 
        let db;

        // Configuração do IndexedDB
        const request = indexedDB.open("FormDB", 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("usuarios", { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = e => db = e.target.result;

        // Salvar no IndexedDB
        document.getElementById('meuForm').onsubmit = e => {
            e.preventDefault();
            const transaction = db.transaction(["usuarios"], "readwrite");
            transaction.objectStore("usuarios").add({
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value
            });
            transaction.oncomplete = () => {
                alert("Salvo offline!");
                document.getElementById('meuForm').reset();
            };
        };

        // Sincronizar (POST)
        async function sincronizarDados() {
            const status = document.getElementById('status');
            status.innerText = "Sincronizando...";
            const transaction = db.transaction(["usuarios"], "readonly");
            const dados = await new Promise(res => transaction.objectStore("usuarios").getAll().onsuccess = e => res(e.target.result));

            if (dados.length === 0) return status.innerText = "Nada para sincronizar.";

            for (let item of dados) {
                await fetch(SHEETS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(item) });
            }

            db.transaction(["usuarios"], "readwrite").objectStore("usuarios").clear();
            status.innerText = "Sincronizado com sucesso!";
            buscarDadosDaPlanilha(); // Atualiza a tabela após sincronizar
        }

        // Buscar dados da Planilha (GET)
        async function buscarDadosDaPlanilha() {
            const status = document.getElementById('status');
            status.innerText = "Buscando dados...";
            
            try {
                const response = await fetch(SHEETS_URL);
                const dados = await response.json();
                
                const tbody = document.querySelector("#tabelaDados tbody");
                tbody.innerHTML = ""; // Limpa a tabela

                dados.forEach(item => {
                    const row = `<tr>
                        <td>${item.nome}</td>
                        <td>${item.email}</td>
                        <td>${new Date(item.data).toLocaleString()}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                status.innerText = "Tabela atualizada!";
            } catch (err) {
                status.innerText = "Erro ao buscar dados. Verifique se a URL está correta e implantada como 'Qualquer pessoa'.";
                console.error(err);
            }
        }
    </script>
</body>
</html>